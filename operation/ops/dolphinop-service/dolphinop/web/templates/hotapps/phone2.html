{% extends "html5_generic.html" %}
{% load compress %}
{% load i18n %}

{% block manifest %}manifest="appbox.appcache"{% endblock %}

{% block title %}{% trans 'AppBox' %}{% endblock %}

{% block body %}
    <div id="loading">{% trans 'Loading...' %}</div>
    <div class="body">
        <div class="header">
            <img class="logo" src="{{STATIC_URL}}image/pages/hotapps/hotapps.png" title="Hot Apps" />
        </div>
        <div id="search_bar">
            <div class="searchbox">
                <form><input></input></form>
                <span class="search_btn btn"></span>
                <span class="cancel_btn btn" style="display:none;"></span>
            </div>
        </div>
        <div class="main">
            <div class="hot_apps">
                <div class="tab_wrap">
                    <div class="menus">
                        <ul>
                            <li id="left_tab" class="menu_tab"><a href="#left">{% trans 'New Releases' %}</a></li>
                            <li id="middle_tab" class="menu_tab"><a href="#middle">{% trans 'Hot Today' %}</a></li>
                            <li id="right_tab" class="menu_tab last"><a href="#right">{% trans 'App Album' %}</a></li>
                        </ul>
                        <div class="clear"></div>
                    </div>
                </div>
                <div id="banners"></div>
                <div>
                    <div id="left_wrap" style="display:none;">
                        <div id="left_content" class="content"></div>
                        <div class="footer">{% trans 'AppBox &copy;2013' %}</div>
                    </div>
                    <div id="middle_wrap" style="display:none;">
                        <div id="middle_content" class="new_apps content"></div>
                        <div class="bottom">
                            <span class="loading_more">
                                <label>{% trans 'Loading...' %}</label>
                                <a href="javascript:void(0);" onclick="loadApps('middle');" style="display:none;">{% trans 'Load More Apps' %}</a>
                            </span>
                            <span class="go_top">
                                <a href="javascript:void(0);" onclick="window.scrollTo(0,1);">{% trans 'Top' %}</a>
                            </span>
                        </div>
                    </div>
                    <div id="right_wrap" style="display:none;">
                        <div class="more_apps">
                            <div>
                                <ul id="right_content" class="content"></ul>
                                <div class="clear"></div>
                            </div>
                        </div>
                        <div class="footer">{% trans 'AppBox &copy;2013' %}</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div id="cateapps_wrap" class="body" style="display:none;">
        <div id="cateapps_tab" class="tab_wrap">
            <span id="cateapps_title">Installed necessary</span>
        </div>
        <div id="cateapps_content" class="content"></div>
        <div class="bottom">
            <span class="loading_more">
                <label>{% trans 'Loading...' %}</label>
                <a href="javascript:void(0);" onclick="loadApps('cateapps');" style="display:none;">{% trans 'Load More Apps' %}</a>
            </span>
            <span class="go_top">
                <a href="javascript:void(0);" onclick="window.scrollTo(0,40);">{% trans 'Top' %}</a>
            </span>
        </div>
    </div>
    <div id="details_wrap" class="body" style="display:none;">
        <div id="details_tab"></div>
        <div id="details_content" class="content"></div>
        <div class="footer">{% trans 'AppBox &copy;2013' %}</div>
    </div>
    <div id="search_wrap" class="body" style="display:none;">
        <div id="search_tab"></div>
        <div id="search_content" class="content"></div>
        <div class="bottom" style="display:none;">
            <span class="loading_more">
                <label>{% trans 'Loading...' %}</label>
                <a href="javascript:void(0);" onclick="searchApps();" style="display:none;">{% trans 'Load More Apps' %}</a>
            </span>
            <span class="go_top">
                <a href="javascript:void(0);" onclick="window.scrollTo(0,40);">{% trans 'Top' %}</a>
            </span>
        </div>
    </div>
    <div id="pop_wrapper" style="display:none;">
        <div class="pop_content">
            <a class="close_button" href="javascript:void(0);" onclick="$('#pop_wrapper').hide();"></a>
            <a class="prev_button" href="javascript:void(0);"></a>
            <a class="next_button" href="javascript:void(0);"></a>
            <img />
        </div>
    </div>
    
    <script type='text/html' id='banners_tmpl'>
        <div class="image_scrollbox">
            <% var count = obj.length; %>
            <ul class="image_scroll" style="width:<%=count*50%>%">
            <% for (var i = 0; i < count; ++i) {%>
            <% var topItem = obj[i]; %>
                <li class="slice" style="width:<%=100/count%>%">
                <% if (topItem.category_id) { %>
                    <% localStorage.setItem("cate:" + topItem.category_id, topItem.category_name); %>
                    <a href='#cateapps:<%=topItem.category_id%>' onclick="track(this, 'image', '<%="cate:" + addslashes(topItem.category_name)%>' , '<%=topItem.category_id%>');">
                <% } else { %>
                    <% var app = topItem.application; %>
                    <% sessionStorage.setItem("app:" + app.id, JSON.stringify(app)); %>
                    <a href='#details:<%=app.id%>' onclick="track(this, 'image', '<%="app:" + addslashes(app.title)%>' , '<%=app.id%>');">
                <% } %>
                        <img src='<%=topItem.top_pic%>' />
                    </a>
                </li>
            <% } %>
            </ul>
        </div>
        <div class="image_scrollbar">
            <% for (var i = 0; i < count; i+=2) {%>
                <span <% if (i == 0) { %>class="active"<% } %>></span>
            <% } %>
        </div>
    </script>
    <script type='text/html' id='middle_tmpl'>
        <% var itemColors = ['', 'even']; %>
        <% for (var i = 0; i < apps.length; ++i) {%>
        <% var app = apps[i]; %>
        <% sessionStorage.setItem("app:" + app.id, JSON.stringify(app)); %>
        <a class="recomment_app_wrap <%=itemColors[i%2]%>" href="#details:<%=app.id%>" onclick="track(this, 'item', '<%=addslashes(app.title)%>' , '<%=app.id%>');">
            <div class="recomment_app_left">
                <img class="lazy" src="{{ STATIC_URL }}image/pages/hotapps/box.png" data-original="<%=app.icon%>" />
            </div>
            <div class="recomment_app_right">
                <h1><%=app.title%></h1>
                <% if (app.is_hot) { %><div class="hot"></div><% } %>
                <% if (app.is_new) { %><div class="new"></div><% } %>
                <p><%=app.short_description%></p>
            </div>
            <div class="recomment_next">
                <span></span>
            </div>
            <div class="clear"></div>
        </a>
        <% } %>
    </script>
    <script type='text/html' id='left_tmpl'>
        <div class="apps twin_list">
            <ul>
            <% for (var i = 0; i < apps.length; ++i) {%>
            <% var app = apps[i]; %>
            <% sessionStorage.setItem("app:" + app.id, JSON.stringify(app)); %>
                <li <% if (i % 3 == 2) { %> class="last" <% } %>>
                    <a class="recomment_app_wrap" href="#details:<%=app.id%>" onclick="track(this, 'item', '<%=addslashes(app.title)%>' , '<%=app.id%>');">
                        <div class="recomment_app_left">
                            <img class="lazy" src="{{ STATIC_URL }}image/pages/hotapps/box.png" data-original="<%=app.icon%>" />
                        </div>
                        <div class="recomment_app_right">
                            <h1><%=app.title%></h1>
                            <% if (app.is_hot) { %><div class="hot"></div><% } %>
                            <% if (app.is_new) { %><div class="new"></div><% } %>
                            <p class="rating">
                                <% var rating = app.app_rating; %>
                                <% var star = ""; %>
                                <% for (var n = 0; n < 5; ++n) { %>
                                    <% if (n+0.5 > rating) { %>
                                        <% star = "gray"; %>
                                    <% } else if (n+1 > rating) { %>
                                        <% star = "half"; %>
                                    <% } %>
                                    <span class="<%=star%>"></span>
                                <% } %>
                            </p>
                            <% if (app.pub_time) { %>
                            <p class="date"><%=app.pub_time || '08/13/2012'%></p>
                            <% } %>
                        </div>
                        <div class="clear"></div>
                    </a>
                </li>
            <% } %>
            </ul>
            <div class="clear"></div>
        </div>
    </script>
    <script type='text/html' id='right_tmpl'>
        <% var itemColors = ['', 'even']; %>
        <% for (var i = 0; i < obj.length; ++i) {%>
        <% var cate = obj[i]; %>
        <% localStorage.setItem("cate:" + cate.id, cate.title); %>
            <li class="<%=itemColors[i%2]%>">
                <a href="#cateapps:<%=cate.id%>" class="recomment_app_wrap" onclick="track(this, 'item', '<%=addslashes(cate.title)%>' , '<%=cate.id%>');">
                    <div class="app_list_left">
                        <img class="lazy" src="{{ STATIC_URL }}image/pages/hotapps/box2.png" data-original="<%=cate.favicon%>" />
                    </div>
                    <div class="app_list_right">
                        <h2><%=cate.title%></h2>
                        <p><%=addslashes(cate.short_description)%></p>
                    </div>
                    <% if (cate.update_number > 0) {%><div class="new"></div><% } %>
                    <div class="clear"></div>
                </a>
            </li>
        <% } %>
    </script>
    <script type='text/html' id='cateapps_tmpl'>
        <% var itemColors = ['', 'even']; %>
        <% for (var i = 0; i < obj.length; ++i) {%>
        <% var app = obj[i]; %>
        <% sessionStorage.setItem("app:" + app.id, JSON.stringify(app)); %>
            <a class="recomment_app_wrap <%=itemColors[i%2]%>" href="#details:<%=app.id%>" onclick="track(this, 'item', '<%=addslashes(app.title)%>' , '<%=app.id%>');">
                <div class="recomment_app_left">
                    <img class="lazy" src="{{ STATIC_URL }}image/pages/hotapps/box.png" data-original="<%=app.icon%>" />
                </div>
                <div class="recomment_app_right">
                    <h1><%=app.title%></h1>
                    <p><%=app.short_description%></p>
                </div>
                <div class="recomment_next">
                    <span></span>
                </div>
                <% if (app.is_hot) { %><div class="hot"></div><% } %>
                <% if (app.is_new) { %><div class="new"></div><% } %>
                <div class="clear"></div>
            </a>
        <% } %>
    </script>
    <script type='text/html' id='search_tmpl'>
        <% var itemColors = ['', 'even']; %>
        <% for (var i = 0; i < obj.length; ++i) {%>
        <% var app = obj[i]; %>
            <a class="recomment_app_wrap <%=itemColors[i%2]%>" href="#details:s<%=app.id%>" onclick="track(this, 'item', '<%=addslashes(app.name)%>' , '<%=app.id%>');">
                <div class="recomment_app_left">
                    <img class="lazy" src="{{ STATIC_URL }}image/pages/hotapps/box.png" data-original="<%=app.icon_url%>" />
                </div>
                <div class="recomment_app_right">
                    <h1><%=app.name%></h1>
                    <p><%=app.short_desc%></p>
                </div>
                <div class="recomment_next">
                    <span></span>
                </div>
                <div class="clear"></div>
            </a>
        <% } %>
    </script>
    <script type='text/html' id='details_tmpl'>
        <div class="app_detail_wrap">
            <div class="app_detail_left">
                <img class="lazy" src="{{ STATIC_URL }}image/pages/hotapps/box.png" data-original="<%=obj.icon%>" />
            </div>
            <div class="app_detail_right">
                <h1><%=obj.title%></h1>
                <p class="rating">
                    <% var rating = obj.app_rating; %>
                    <% var star = ""; %>
                    <% for (var i = 0; i < 5; ++i) { %>
                        <% if (i+0.5 > rating) { %>
                            <% star = "gray"; %>
                        <% } else if (i+1 > rating) { %>
                            <% star = "half"; %>
                        <% } %>
                        <span class="<%=star%>"></span>
                    <% } %>
                    &nbsp;(<%=obj.app_ratingcount%>)
                </p>
            </div>
            <div class="clear"></div>
        </div>
        <div class="app_tools">
            <div class="share">
                <a href="http://m.facebook.com/sharer.php?u=<%=encodeURIComponent(location.href)%>&t=<%=encodeURIComponent(obj.title)%>" onclick="track(this, 'share', '<%=addslashes(obj.title)%>' , '<%=obj.id%>');">
                    <span>{% trans 'Share' %}</span>
                </a>
            </div>
            <div class="app_get">
                <% if (obj.aid && window.androidId) {%>
                    <% obj.download_url = '/api/promotion/track.json?did=' + window.androidId + '&aid=' + obj.aid + '&target=' + encodeURIComponent(obj.download_url); %>
                <% } %>
                <a href="<%=obj.download_url%>" onclick="track(this, 'download', '<%=addslashes(obj.title)%>' , '<%=obj.id%>');">{% trans 'Get it' %}</a>
            </div>
        </div>
        <div class="app_detail_list">
            <ul id="app_content" class="app_items">
                <li>
                    <div class="dotted"><div></div></div>
                    <ul id="details">
                        <li><strong>{% trans 'Size: ' %}</strong><%=obj.app_size%></li>
                        <li><strong>{% trans 'Type: ' %}</strong><%=obj.app_type%></li>
                        <li><strong>{% trans 'Developers: ' %}</strong><%=obj.app_developer%></li>
                        <li><strong>{% trans 'Description: ' %}</strong><%=obj.detail_description.replace(/\r\n/g, '<br />')%></li>
                    </ul>
                    <button class="more_btn more">{% trans 'More' %}</button>
                    <div class="clear"></div>
                </li>
                <% if (obj.screenshots.length > 0 ) {%>
                <li>
                    <div class="dotted"><div></div></div>
                    <div class="screenshots">
                        <% for (var i = 0; i < obj.screenshots.length; ++i) { %>
                        <% var screenshot = obj.screenshots[i]; %>
                        <a onclick="showpop(<%=i%>, <%=obj.screenshots.length%>); track(this, 'image', '<%=addslashes(obj.title)%>' , '<%=i%>');">
                            <img class="lazy" src="{{ STATIC_URL }}image/pages/hotapps/loading2.png" data-original="<%=screenshot.thumbnails%>" data-url="<%=screenshot.pic_url %>"/>
                        </a>
                        <% } %>
                        <div class="clear"></div>
                    </div>
                </li>
                <% } %>
            </ul>
            <div class="clear"></div>
        </div>
    </script>
    <script type='text/html' id='searchDetails_tmpl'>
        <% var edition = obj.editions[0]; %>
        <div class="app_detail_wrap">
            <div class="app_detail_left">
                <img class="lazy" src="{{ STATIC_URL }}image/pages/hotapps/box.png" data-original="<%=edition.icon_url%>" />
            </div>
            <div class="app_detail_right">
                <h1><%=edition.name%></h1>
                <p class="rating">
                    <% var rating = edition.rating; %>
                    <% var star = ""; %>
                    <% for (var i = 0; i < 5; ++i) { %>
                        <% if (i+0.5 > rating) { %>
                            <% star = "gray"; %>
                        <% } else if (i+1 > rating) { %>
                            <% star = "half"; %>
                        <% } %>
                        <span class="<%=star%>"></span>
                    <% } %>
                    &nbsp;(<%=(edition.rating_count || 0)%>)
                </p>
            </div>
            <div class="clear"></div>
        </div>
        <div class="app_tools">
            <div class="share">
                <a href="http://m.facebook.com/sharer.php?u=<%=encodeURIComponent(location.href)%>&t=<%=encodeURIComponent(edition.name)%>" onclick="track(this, 'share', '<%=addslashes(edition.name)%>' , '<%=obj.id%>');">
                    <span>{% trans 'Share' %}</span>
                </a>
            </div>
            <div class="app_get">
                <a href="<%=edition.url%>" onclick="track(this, 'download', '<%=addslashes(edition.name)%>' , '<%=obj.id%>');">{% trans 'Get it' %}</a>
            </div>
        </div>
        <div class="app_detail_list">
            <ul id="app_content" class="app_items">
                <li>
                    <div class="dotted"><div></div></div>
                    <ul id="details">
                        <li><strong>{% trans 'Developers: ' %}</strong><%=obj.developer.name%></li>
                        <li><strong>{% trans 'Description: ' %}</strong><%=edition.description.replace(/\r\n/g, '<br />')%></li>
                    </ul>
                    <button class="more_btn more">{% trans 'More' %}</button>
                    <div class="clear"></div>
                </li>
                <% if (edition.screenshots.length > 0 ) {%>
                <% var length = Math.min(edition.screenshots.length, 6); %>
                <li>
                    <div class="dotted"><div></div></div>
                    <div class="screenshots">
                        <% for (var i = 0; i < length; ++i) { %>
                        <% var screenshot = edition.screenshots[i]; %>
                        <a onclick="showpop(<%=i%>, <%=edition.screenshots.length%>); track(this, 'image', '<%=addslashes(edition.name)%>' , '<%=i%>');">
                            <img class="lazy" src="{{ STATIC_URL }}image/pages/hotapps/loading2.png" data-original="<%=screenshot.image_url%>" data-url="<%=screenshot.image_url %>"/>
                        </a>
                        <% } %>
                        <div class="clear"></div>
                    </div>
                </li>
                <% } %>
            </ul>
            <div class="clear"></div>
        </div>
    </script>
    <script type='text/html' id='related_tmpl'>
        <% if (obj.length > 0) { %>
        <li>
            <div class="dotted"><div></div></div>
            <ul>
                <li><strong>{% trans 'You may also like' %}</strong></li>
                <li class="apps icon_list">
                    <ul class="related">
                    <% for (var i = 0; i < obj.length; ++i) { %>
                    <% var app = obj[i]; %>
                    <% sessionStorage.setItem("app:" + app.id, JSON.stringify(app)); %>
                        <li>
                            <a href="#details:<%=app.id%>" onclick="track(this, 'related', '<%=addslashes(app.title)%>' , '<%=app.id%>');">
                                <img class="lazy" src="{{ STATIC_URL }}image/pages/hotapps/box.png" data-original="<%=app.icon%>" />
                                <h2><%=app.title%></h2>
                            </a>
                        </li>
                    <% } %>
                    </ul>
                </li>
            </ul>
            <% } %>
        </li>
    </script>

{% endblock %}

{% block script %}
<script type="text/javascript">
    var product = 'hotapps';
    var version = '2.0';
    var platform = '{{ platform }}'; 
    var lang = '{{ language }}';
    var staticPath = '{{ STATIC_URL }}';
    var auto_loading = {{ auto_loading }};
    var strings = {
        LOADING : '{% trans "Loading..." %}',
        NO_MORE_APPS : '{% trans "No More Apps" %}',
        MORE : '{% trans "more" %}',
        LESS : '{% trans "less" %}'
    };
</script>
{% endblock %}

{% block tracking %}
<script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', '{{ ga_account }}']);
    _gaq.push(['_trackPageview']);
    _gaq.push(['_trackPageLoadTime']);

    (function() {
        var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
        ga.src = '{{ STATIC_URL }}scripts/ga.js';
        var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
</script>
{% endblock %}

{% block style %}
{% compress css inline %}
<style>
    *{ margin:0; padding:0; vertical-align:top;}
    .clear{ clear:both; }
    img{ border:0 none; }
    ul li{ list-style:none;}
    a{ text-decoration:none; -webkit-tap-highlight-color: rgba(0,0,0,0);}
    a:hover{ text-decoration:none;}
    button{-webkit-tap-highlight-color: rgba(0,0,0,0);}

    html{ min-width:320px;}
    body{ margin: 0 auto; font-family:"Diorid Sans"; background:#fff;-webkit-tap-highlight-color:rgba(0,0,0,0);}

    #pop_wrapper{ z-index:999; position:absolute; width:100%; height:100%; top:0; left:0; background:rgba(0, 0, 0, 0.5);}
    #pop_wrapper img{ max-height:400px; min-height:120px; width:240px; height:auto;}
    .horizontal #pop_wrapper img{ max-width:400px; min-width:120px; height:240px; width:auto;}
    .pop_content{ border:2px solid #e6e6e6; background:#ffffff; top:50%; left:50%; position:fixed; -webkit-box-shadow: 0 0 25px #333;}
    .close_button{ position:absolute;top:-15px;right:-15px;background:url("{{STATIC_URL}}image/pages/hotapps/close.png") no-repeat; width:30px; height:30px; -webkit-background-size:30px auto;}
    .prev_button{ position:absolute;left:-20px;top:50%;margin-top:-25px;background:url("{{STATIC_URL}}image/pages/hotapps/arrows.png") no-repeat left top; width:30px; height:55px; -webkit-background-size:60px auto;}
    .next_button{ position:absolute;right:-20px;top:50%;margin-top:-25px;background:url("{{STATIC_URL}}image/pages/hotapps/arrows.png") no-repeat right top; width:30px; height:55px; -webkit-background-size:60px auto;}

    .header{ /*display:none;*/background:-webkit-gradient(linear,0 0,0 100%,from(#F6F6F6),to(#D2D2D2)); border-bottom:1px solid #909090; height:40px; line-height:40px;}
    .header .logo{ height:40px;}
    .header h1{ font-size:18px; color:#717171; padding:0 20px;}
    .header .search_box{ float:right; border-left:1px solid #c1c1c1;}
    .header .search_box a{ display:block; background:url("{{STATIC_URL}}image/pages/hotapps/search_ico.png") no-repeat scroll -4px 0px transparent; width:45px; height:40px; border-left:1px solid #ffffff;}
    .tab_wrap {border-top:1px solid #ffffff;border-bottom:1px solid #909090;line-height:40px;font-size:14px; text-align:center;color:#676767;text-shadow: 0 1px 1px #fff;}

    .menus{ margin:5px; overflow:hidden;}
    .menus ul{ background: -webkit-gradient(linear,0 0,0 100%,from(#FDFDFD),to(#D2D2D2)); border:1px solid #909090; border-radius:4px;}
    .menus ul li{ display:inline-block; width:33.3%; box-sizing:border-box;}
    .menus ul li.active{ background: -webkit-gradient(linear,0 0,0 100%,from(#52C002),to(#4AAC03)); -webkit-box-shadow: 0 1px 2px #3c8101 inset;}
    .menus a{ display:block; color:#505050;}
    .menus .active a{ color:#ffffff; text-shadow: 0 1px 1px #676767;}
    #middle_tab{border-left:1px solid #909090; border-right:1px solid #909090;}

    .content {min-height:300px;}
    .main .image_scrollbox{ border-bottom:1px solid #d8d8d8; background:url("{{STATIC_URL}}image/pages/hotapps/image_slider_bg.png") repeat-x; border-top:1px solid #ffffff; overflow:hidden; padding:0 10px; min-height:80px;}
    .image_scroll{ margin:0px auto; padding:10px 0;}
    .image_scroll li{ display:inline-block;}
    .image_scroll a{ padding:0 10px; display:block;}
    .image_scroll img{ width:100%; }
    .main .image_scrollbar{ border-bottom:1px solid #d8d8d8;height:10px;padding-top:3px; text-align:center;}
    .main .image_scrollbar span{ background:url("{{STATIC_URL}}image/pages/hotapps/bullets.png") no-repeat; width:6px;height:6px; display:inline-block; margin:0 8px; -webkit-background-size:6px auto;}
    .main .image_scrollbar span.active{ background-position:0 -6px;}

    .recomment_app_wrap{display:block; padding:10px; border-top:1px solid #ffffff; border-bottom:1px solid #d8d8d8; position:relative;}
    .even{background:#f3f3f3;}
    .recomment_app_left,.app_detail_left{ float:left; width:65px;}
    .recomment_app_right,.app_detail_right{ float:left; width:70%;}
    .recomment_app_left img,.app_detail_left img{ width:55px; height:55px;}
    .recomment_app_left span, .apps span{ background:url("{{STATIC_URL}}image/pages/hotapps/like.png") no-repeat; text-indent:18px; display:inline-block; color:#646464; font-size:13px; line-height:14px; margin-top:5px; overflow:hidden; -webkit-background-size:16px auto; width:55px; text-align:left;}
    .recomment_app_right h1{ color:#505050; font-size:20px; font-weight:bold; max-width:95%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;}
    .recomment_app_right p{ margin:3px 3px 0 0; font-size:12px; color:#646464; line-height:16px; height:32px; overflow:hidden;}
    .recomment_next span{ background:url({{STATIC_URL}}image/pages/hotapps/next_arrow.png) no-repeat; width:8px; height:13px; margin-top:24px; float:right; -webkit-background-size:8px auto;}
    .rating span{ display:block; float:left; margin-top:-1px; width:16px; height:16px; background:url("{{STATIC_URL}}image/pages/hotapps/green-star.png"); -webkit-background-size:16px auto;}
    .rating span.half{ background-image:url("{{STATIC_URL}}image/pages/hotapps/half-star.png");}
    .rating span.gray{ background-image:url("{{STATIC_URL}}image/pages/hotapps/gray-star.png");}

    .bottom a{ display:block; color:#777;}
    .bottom span{ background:-webkit-gradient(linear,0 0,0 100%,from(#F6F6F6),to(#D2D2D2)); text-align:center; line-height:40px; color:#777; font-size:16px; margin:5px; border:1px solid #c9c9c9;border-radius:3px; display:inline-block;}
    .bottom .go_top{ width:73px; margin-left:0px;}
    .go_top a{ background:url("{{STATIC_URL}}image/pages/hotapps/top.png") no-repeat 8px 12px; background-size:16px auto; text-indent:20px;}
    .loading_more{ width:228px;}

    .app_detail_wrap, #cateapps_content{ background:-webkit-gradient(linear,0 0,0 30,from(#F0F0F0),to(#FFF));}
    .app_detail_wrap{ border-top:1px solid #ffffff;padding:10px 15px 15px;}
    .app_detail_right h1{font-size:16px;color:#505050; font-weight:bold; height:36px;}
    .app_detail_right p{margin-top:7px; font-size:12px; color:#9c9c9c; line-height:16px; height:16px;}

    .app_tools{ margin: 0 10px 15px;}
    .app_tools div{display:inline-block; width:50%; text-align:center;}
    .app_tools .like a{ display:inline-block; padding:0 24px; height:30px; line-height:30px; border-radius:5px; background:url("{{STATIC_URL}}image/pages/hotapps/like_btn.png"); border:1px solid #c9c9c9; -webkit-background-size:100% 100%; color:#50b501;}
    .app_tools .like span{ display:block; text-align:right; width:90px; background:url("{{STATIC_URL}}image/pages/hotapps/green_like.png") no-repeat 0 8px; -webkit-background-size:16px auto;}
    .app_tools .like span.like{ background:url("{{STATIC_URL}}image/pages/hotapps/like.png") no-repeat 0 8px;}
    .app_tools .share a{ display:inline-block; padding:0 30px; height:30px; line-height:30px; border-radius:5px; background:-webkit-gradient(linear, 0 0, 0 100%, from(#f9f9f9), to(#d2d2d2)); border:1px solid #c9c9c9; color:#50b501;}
    .app_tools .share span{ display:block; text-align:right; width:78px; background:url("{{STATIC_URL}}image/pages/hotapps/share.png") no-repeat 0 8px; -webkit-background-size:16px auto;}
    .app_tools img{ height:33px;}
    .app_get a{ width:138px; height:30px; border-radius:5px; border:1px solid #49a500; display:inline-block; background:-webkit-gradient(linear, 0 0, 0 100%, from(#67dd0a), to(#4eb100)); line-height:30px; font-size:17px;color:#ffffff;text-align:center; text-shadow: 0 1px 1px #676767;}

    .app_detail_list{ margin:0 10px 0;}
    .app_detail_list li{ list-style:disc inside; color:#67cc17;}
    .app_detail_list .dotted{ border-top:1px dashed #67cc17; width:96%; margin-left:4%; position:relative;}
    .app_detail_list .dotted div{ height:6px; width:6px; border-radius:3px; background:#67CC17; position:absolute; left:-12px; top:-4px;}
    .app_detail_list ul li{ list-style:none; line-height:18px; color:#646464; font-size:14px;margin-top:3px;}
    .app_detail_list ul ul{ margin:0 10px;}
    .app_detail_list .more_details{margin:25px 10px 0;}
    .app_detail_list .more_details{display:none;}
    .app_detail_list .more_btn{background:-webkit-gradient(linear, 0 0, 0 100%, from(#f9f9f9), to(#d2d2d2)); border:1px solid #c9c9c9; border-radius:5px; width:75px; height:30px; line-height:30px; color:#242424; float:right;font-size:12px;margin-right:10px; text-shadow: 0 1px 1px #fff; margin-bottom:10px;}

    .screenshots{margin-top:10px;}
    .screenshots img{float:left;margin:0 5px 10px;min-width:90px; max-width:135px; min-height:90px; max-height:135px; -webkit-box-shadow:0 0 5px #444;}

    #app_content strong, {font-weight:bold; color:#898989;}
    #app_content .related{margin:-10px -20px;}

    #details{ overflow:hidden; height:140px; margin-bottom:10px; }

    #middle_content .icon_list{padding-top:12px;}
    #middle_content .icon_list ul{border-top:1px solid #E5E5E5;}

    .icon_list li{ float:left; width:33.3%;}
    .icon_list a{ display:block; text-align:center;}
    .icon_list img { width:56px; height:56px; margin:6px auto 0; display:block;}
    .icon_list .app_number{ position:absolute; background:url({{STATIC_URL}}image/pages/hotapps/more.png) no-repeat; -webkit-background-size:30px auto; width:30px; height:30px;line-height:30px; text-align:center; font-size:15px; font-weight:bold; color:#ffffff; margin:-70px 0 0 55px;}
    .icon_list h2 { display:inline-block; font-size:13px; color:#505050; font-weight:bold; margin-bottom:6px; width:94px; height:32px; line-height:16px; overflow:hidden;}

    .icon_list.border li{ float:left; border-right:1px solid #e5e5e5; border-bottom:1px solid #e5e5e5; box-sizing:border-box;}
    .icon_list.border li.last { border-right:none;}

    .twin_list li{ float:left; width:50%;}
    .twin_list li:nth-child(2n){ margin-left:-1px; border-left:1px solid #d8d8d8;}
    .twin_list .recomment_app_wrap{ padding-left:54px;}
    .twin_list .recomment_app_left{ margin-left:-44px; width:40px;}
    .twin_list .recomment_app_left img{ width:40px; height:40px;}
    .twin_list .recomment_app_right{ float:none; width:auto; height:45px;}
    .twin_list .recomment_app_right h1{ font-size:14px;}
    .twin_list .recomment_app_right p{ height:auto; margin:0;}
    .twin_list .rating span{ width:12px; height:12px; -webkit-background-size:12px auto;}

    .top{ position:absolute; top:0; width:320px; background:#fff;}
    .footer{background:#f3f3f3;text-align:center;border-top:1px solid #d8d8d8;height:39px;line-height:39px;color:#b6b6b6;text-shadow: 0 1px 1px #fff;font-size:14px;margin-top:-1px;}

    .more_apps a{ display:block; padding:10px;}
    .app_list_left{ margin-right:15px; float:left;}
    .app_list_left img{ width:130px; height:78px;}
    .app_list_right h2{ color:#505050; font-size:16px; font-weight:bold; line-height:20px; max-height:40px; overflow:hidden; margin-bottom:5px;}
    .app_list_right p{ font-size:12px; color:#646464; line-height:16px; max-height:32px; overflow:hidden;}
    .new, .hot{ position:absolute; top:-1px; right:0px; width:30px; height:30px; -webkit-background-size:30px auto; background-position:right top; background-repeat:no-repeat;}
    .new{ background-image:url("{{STATIC_URL}}image/pages/hotapps/new2.png");}
    .hot{ background-image:url("{{STATIC_URL}}image/pages/hotapps/hot.png");}

    .bottom{width:320px; margin:auto;}

    #search_bar input {height: 35px;border: none;width: 100%;}
    form {margin-right:65px;}
    .searchbox {border-radius:8px; border:1px solid #389D00; padding:0 8px;}
    #search_bar {display:none;padding:5px 5px 0;}
    .btn {float:right;width:30px; height:30px; margin-top:-32px;position:relative;}
    .search_btn {background:url("{{STATIC_URL}}image/pages/hotapps/search.png") no-repeat center;}
    .cancel_btn {margin-right: 35px; background:url("{{STATIC_URL}}image/pages/hotapps/delete.png") no-repeat center; -webkit-background-size:50% auto;}

    #loading{position:absolute;top:0;left:0;z-index:9;width:100px;height:40px;background:url('images/loading.gif') no-repeat 0 center;font-size:17px;line-height:42px;color:#ACACAC;padding-left:30px;background-size:20px;display:none;}
</style>
{% endcompress %}
{% endblock %}

{% block body_script %}
{% compress js %}
    <script type="text/javascript" src="{{ STATIC_URL }}scripts/zepto1.0.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}scripts/lazyload.min.js"></script>
    <script type="text/javascript" src="{{ STATIC_URL }}scripts/template.js"></script>
    <script>
        var loadApps = null;
        var searchApps = null;
        var vote = null;
        var track = null;
        var addslashes = null;
        var shortNum = null;
        var showpop = null;
        var androidId = null;

        if(window.dolphinmeta){
            (function () {
                window.getAndroidId = function(ctx, data){
                    androidId = data;
                };
                window.location = "dolphin://jsreq/dolphin/getAndroidId?callback=window.getAndroidId";
            })();
        }


        (function ($) {
            var isAjaxCompleted = true;

            var columnName = '';
            var categoryId = '';
            var categoryTitle = null;

            var columnPage = {};
            var columnContent = {};
            var columnWrap = {};
            var columnTab = {};
            var appLoad = {};
            var pageLoad = null;
            var isLoading = false;

            var orientation = 0;
            var timeInt = null;

            var tabs = new Array("left", "middle", "right", "cateapps", "details", "search");

            var quixey_id = 2721778490;
            var quixey_secret = "4w6z8cut395mgrspwbb2dscqakgyfzz1";

            var loadingIcon = $("#loading");

            var viewWidth = document.documentElement.clientWidth;
            var viewHeight = document.documentElement.clientHeight;
            loadingIcon.css("left", (viewWidth - 130)/2 + "px");
            loadingIcon.css("top", (viewHeight - 40)/2 + "px");

            loadingIcon.show();


            // data api host
            // var apiHost = 'http://content.admin.dolphin.com/pages/hotapps';
            var apiHost = '.';

            // dolphin tracking
            var trackHost = 'http://track.dolphin-browser.com/track/site.gif?';

            // related apps
            var relatedUrl = './relevant.html?os=android&l=en_US&id=';

            // voting url
            var votingUrl = './lovecount?os=android&l=en_US&id=';

            // app details url
            var detailsUrl = './details.html?os=android&l=en_US&format=json&id=';

            // screen shot
            var prev_image = null;
            var next_image = null;

            function initial() {

                for (i in tabs)
                {
                    var tab = tabs[i];
                    
                    columnPage[tab] = 1;
                    columnContent[tab] = $('#' + tab + '_content');
                    columnWrap[tab] = $('#' + tab + '_wrap');
                    columnTab[tab] = $('#' + tab + '_tab');
                }

                appLoad = {
                    left: false,
                    middle: true,
                    right: false,
                    cateapps: true,
                    details: false,
                    search: true
                };

                pageLoad = $('#page_load');

                categoryTitle = $('#cateapps_title');
            }

            function renderResults(results){
                loadTemplate(results, "search");

                $('.bottom', columnWrap.search).show();
            }

            function loadSearchDetails(id){
                $.ajax({
                    url: "https://api.quixey.com/1.0/get_app",
                    data: {
                        partner_id: quixey_id,
                        partner_secret: quixey_secret,
                        app_id: id,
                        platform_ids: "[2005]"
                    },
                    dataType: "jsonp",
                    success: function(data){
                        if (data && data.app){
                            loadAppDetails(data.app);
                        } else {
                            //TODO: error
                        }
                    }
                });
            }

            searchApps = function() {
                if (columnPage.search == 1){
                    loadingIcon.show();
                    $('.loading_more label', columnWrap.search).html(strings.LOADING);
                } else {
                    $('.loading_more a', columnWrap.search).hide();
                    $('.loading_more label', columnWrap.search).show();
                }

                $.ajax({
                    url: "https://api.quixey.com/1.0/search",
                    data: {
                        partner_id: quixey_id,
                        partner_secret: quixey_secret,
                        q: $('input')[0].value,
                        platform_ids: "[2005]",
                        skip: (columnPage.search - 1) * 10
                    },
                    dataType: "jsonp",
                    success: function(data){
                        if (data){
                            renderResults(data.results);
                        }
                    },
                });
            }

            loadApps = function(columnName) {

                loadingApps(columnName, auto_loading);

                var localData = null;
                var storageKey = null;
                var pageNum = columnPage[columnName];

                // only cache the first page
                if (pageNum == 1) {
                    storageKey = columnName;

                    if (columnName == "cateapps") {
                        storageKey = "cateapps:" + categoryId;
                    }

                    localData = JSON.parse(localStorage.getItem(storageKey));
                }

                var url = getLoadingPath() + '&page=' + pageNum;

                    $.get(url, function (data) {

                            // only cache the first page
                            if (pageNum == 1) {
                                if (data) {
                                    localStorage.setItem(storageKey, JSON.stringify(data));

                                    // clear and reset the old content
                                    columnContent[columnName].html('');
                                    columnPage[columnName] = 1;
                                    loadTemplate(data, columnName);
                                }
                            } else {
                                loadTemplate(data, columnName);
                            }

                            isLoading = false;
                    });

                    if (localData) {
                        loadTemplate(localData, columnName);
                    }
            }

            vote = function(element, name, id) {
                var span = $('span', element);
                var loveCount = parseInt(span.html());
                if (!isNaN(loveCount)) {
                    span.html(loveCount + 1);
                }
                span.addClass('like');
                $.get(votingUrl + id);

                track(element, 'like', name , id);
            }

            function loadingApps(columnName, auto_loading) {
                if (!auto_loading) {
                    var pagination = $('.loading_more a', columnWrap[columnName]);
                    var loading = $('.loading_more label', columnWrap[columnName]);
                        pagination.hide();
                        loading.show();
                }
            }

            function loadTemplate(data, columnName) {

                loadingIcon.hide();

                var pagination = $('.loading_more a', columnWrap[columnName]);
                var loading = $('.loading_more label', columnWrap[columnName]);

                if (data) {
                    var content = tmpl(columnName + '_tmpl', data);

                    if (content) {

                        if (!auto_loading) {
                            loading.hide();
                            pagination.show();
                        }

                        columnContent[columnName].append(content);

                        columnPage[columnName]++;

                        $('img.lazy').lazyload();
                        $('img.lazy').removeClass('lazy');

                    } else {
                        loading.html(strings.NO_MORE_APPS);
                        appLoad[columnName] = false;
                    }
                } else {
                    loading.html(strings.NO_MORE_APPS);
                    appLoad[columnName] = false;
                }
            }

            function loadRelatedApps(appId) {

                var url = relatedUrl + appId;

                $.get(url, function (data) {
                    if (data) {
                        $("#app_content").append(tmpl('related_tmpl', data));
                        
                        $('img.lazy').lazyload($.load);
                        $('img.lazy').removeClass('lazy');
                    }
                });
            }

            function registerDetailsEvents() {
                var wrapper = $('#details');

                $('.more_btn').bind('click', function () {
                    var btn = $(this);
                    if (btn.hasClass("more")) {
                        wrapper.css('height', 'auto');
                        btn.removeClass("more");
                        btn.html(strings.LESS);
                    } else {
                        wrapper.css('height', '140px');
                        btn.addClass("more");
                        btn.html(strings.MORE);
                    }
                });
            }
            
            function registerEvents() {

                window.addEventListener("resize", checkOrientation, false);
                window.addEventListener("orientationchange", checkOrientation, false);

                window.addEventListener('hashchange', function () {
                    var hash = window.location.hash;
                    var newColumnName = "middle";

                    if (hash != '') {
                        if (hash.substr(0, 10) == "#cateapps:") {
                            newColumnName = "cateapps";

                            categoryId = hash.slice(10);
                            categoryTitle.html(localStorage.getItem("cate:" + categoryId));
                            $('.loading_more label', columnWrap[newColumnName]).html("Loading...");

                            appLoad[newColumnName] = true;
                            columnPage[newColumnName] = 1;
                            columnContent[newColumnName].html('');

                        } else if (hash.substr(0, 9) == "#details:") {
                            // no paging or loading is required
                            // render the details page directly
                            newColumnName = "details";
                            columnPage[newColumnName] = 0;

                            var appId = hash.slice(9);

                            if(appId[0] == 's'){
                                loadingIcon.show();

                                columnContent.details.html('');
                                loadSearchDetails(appId.substr(1));
                            }else{
                                var appContent = JSON.parse(sessionStorage.getItem("app:" + appId));

                                if ( appContent ) {
                                    loadAppDetails(appContent);
                                } else {
                                    $.get(detailsUrl + appId, function (data) {
                                        if (data){
                                            loadAppDetails(data);
                                        }else{
                                            // failed to load detail data, return to home
                                            window.location.hash = '';
                                        }
                                    });
                                }
                            }
                        } else {
                            var name = hash.slice(1);
                            if (columnTab[name]) {
                                newColumnName = name;
                            }
                        }
                    }

                    switchTabs(newColumnName);
                });

                if (auto_loading) {
                    window.addEventListener('scroll', function () {
                        if (
                            appLoad[columnName] &&
                            (columnPage[columnName] > 1) &&
                            (( window.screen.availHeight + document.body.scrollTop) >= document.body.scrollHeight) &&
                            !isLoading
                        ) {
                            isLoading = true;
                            loadApps(columnName);
                        }
                    });
                }

                $('.search_btn').bind('click', function(){
                    location.hash = "search";

                    // clear and reset the old content
                    columnContent.search.html('');
                    columnPage.search = 1;

                    searchApps();
                });

                $('.cancel_btn').bind('click', function(){
                    $('input')[0].value = '';
                    $(this).hide();
                });

                $('form').bind('submit', function(){
                    location.hash = "search";

                    // clear and reset the old content
                    columnContent.search.html('');
                    columnPage.search = 1;

                    searchApps();
                    return false;
                });

                $('input').bind('keyup', function(){
                    if (this.value != ""){
                        $('.cancel_btn').show();
                    } else {
                        $('.cancel_btn').hide();
                    }
                });
            }

            function loadAppDetails(appData) {
                loadingIcon.hide();

                if (appData) {
                    if (appData.icon){
                        columnContent.details.html(tmpl('details_tmpl', appData));
                    } else {
                        columnContent.details.html(tmpl('searchDetails_tmpl', appData));
                    }

                    registerDetailsEvents();
                    $('img.lazy').lazyload();
                    $('img.lazy').removeClass('lazy');

                    loadRelatedApps(appData.id);
                } else {
                    window.location.hash = "";
                }
            }

            function checkOrientation() {
                if (orientation != window.orientation) {
                    orientation = window.orientation;

                    var body = $('body');
                    if (orientation % 180 != 0) {
                        body.addClass('horizontal');
                    } else {
                        body.removeClass('horizontal');
                    }

                    if ($("#pop_wrapper")[0].clientWidth > 0) {
                        setTimeout(adjust_pop, 500);
                    }

                    viewWidth = document.documentElement.clientWidth;
                    viewHeight = document.documentElement.clientHeight;
                    loadingIcon.css("left", (viewWidth - 130)/2 + "px");
                    loadingIcon.css("top", (viewHeight - 40)/2 + "px");
                }
            }

            function switchTabs(newColumnName) {

                if (columnTab[newColumnName]
                    && columnName != newColumnName) {
                    
                    // columnName is '' in first loading
                    if (columnName) {
                        columnTab[columnName].removeClass('active');
                        columnWrap[columnName].hide();
                    }

                    columnName = newColumnName;

                    columnTab[columnName].addClass('active');
                    columnWrap[columnName].show();

                    //add ga track
                    if(columnName == "left"){
                        _gaq.push(['_trackEvent','tab','display','left']);
                    }
                    if(columnName == "middle"){              
                        _gaq.push(['_trackEvent','tab','display','middle']);
                    }
                    if(columnName == "right"){
                        _gaq.push(['_trackEvent','tab','display','right']);
                    }

                    if (columnName != 'search' && columnPage[columnName] == 1) {
                        loadApps(columnName);
                    }
                }

                window.scrollTo(0, 1);

                if (columnName != "left" && columnName != "middle") {
                    $("#banners").hide();
                }else{
                    $("#banners").show();
                }

                // hide the pop image
                if ($("#pop_wrapper")[0].clientWidth > 0) {
                    $('#pop_wrapper').hide();
                }

            }

            function getLoadingPath() {

                var path = null;

                switch (columnName) {
                case "left": path = apiHost + '/featured.html'; break;
                case "middle": path = apiHost + '/trend.html'; break;
                case "right": path = apiHost + '/categories.html'; break;
                case "cateapps": path = apiHost + '/cateapps.html'; break;
                }

                var parameter = '?os=' + platform + '&l=' + lang + '&format=json';

                if (columnName == 'cateapps') {
                    parameter += ('&id=' + categoryId);
                }

                return path + parameter;
            }

            function autoScroll() {

                var counter = 1;
                var count = $('.slice').length / 2;
                var container = $('.image_scrollbox');
                var scrollview = $('.image_scroll');
                var scrollbar = $('.image_scrollbar span');

                if (timeInt) {
                    clearInterval(timeInt);
                }

                timeInt = setInterval(function () {

                    if (columnName == 'middle') {

                        var width = container[0].clientWidth - 20;
                        scrollview.css('-webkit-transition', '-webkit-transform .3s linear');
                        scrollview.css('-webkit-transform', 'translate3d(' + -width + 'px, 0, 0)');
                        
                        setTimeout(function () {
                            var first = $('.slice')[0];
                            var second = $('.slice')[1];

                            // move the first element to the last
                            scrollview.append(first.outerHTML);
                            scrollview.append(second.outerHTML);

                            scrollview[0].removeChild(first);
                            scrollview[0].removeChild(second);

                            scrollview.css('-webkit-transition', 'none');
                            scrollview.css('-webkit-transform', 'translate3d(0, 0, 0)');

                            // adjust the scroll bar
                            scrollbar.removeClass('active');
                            scrollbar[counter++].setAttribute('class', 'active');
                            
                            if (counter == count) {
                                counter = 0;
                            }

                        }, 400);
                    }
                }, 5000);
            }

            track = function (element, type, name, url) {

                var event = null;
                var value = url ? (name + ':' + url) : name;

                event = columnName + '_' + type;
                
                if (columnName == "cateapps") {
                    event = categoryTitle.html() + '_' + type;
                }else if (columnName == "details") {
                    event = name +'_'  + type;
                }

                _gaq.push(['_trackEvent', columnName, event, value]);

                // dolphin tracking
                var trackUrl = trackHost + 't=0&v=' + version + '&l=' + lang + '&p=' + product + '_' + platform
                                    + '&w=' + element.offsetLeft + '&h=' + element.offsetTop
                                    + '&col=' + columnName + '&item=' + event + '&src=' + encodeURIComponent(value);
                $.get(trackUrl);
            }

            addslashes = function ( str ) {  
                return (str+'').replace(/([\\"'])/g, "\\$1").replace(/\0/g, "\\0");  
            }

            shortNum = function ( number) {
                if (number >= 10000) {
                    return ">" + Math.floor(number/1000) +"k";
                }
                return number;
            }

            showpop = function(current, len) {
                var wrapper = $('#pop_wrapper');
                wrapper.css('height', $('body').height()+'px');
                wrapper.show();

                var pop_image = $('#pop_wrapper img');
                var thumb_image = $('.screenshots img')[current];

                pop_image.attr('src', thumb_image.attributes['src'].value);
                adjust_pop();

                pop_image.attr('src', thumb_image.attributes['data-url'].value);

                if (current > 0) {
                    $('.prev_button').show();
                    prev_image = function() {
                        showpop(current-1,len);
                    }
                } else {
                    $('.prev_button').hide();
                }
                
                if (current < len - 1) {
                    $('.next_button').show();
                    next_image = function() {
                        showpop(current+1,len);
                    }
                } else {
                    $('.next_button').hide();
                }
            }

            function adjust_pop() {
                var content = $('.pop_content');
                var image = $('#pop_wrapper img');

                content.css('top', document.documentElement.clientHeight/2);
                content.css('margin-top', '-' + image.height() / 2 +'px'); 
                content.css('margin-left', '-' + image.width() / 2 +'px');
            }

            function pop_init() {
                $('#pop_wrapper').bind('touchmove', function (e) {
                    e.preventDefault();
                });

                $('#pop_wrapper img').bind('load', adjust_pop);

                $('.prev_button').bind('click', function() {
                    if (prev_image) prev_image();
                });

                $('.next_button').bind('click', function() {
                    if (next_image) next_image();
                });
            }

            function load_banners() {
                var url = apiHost + '/topfeatured.html?os=' + platform + '&l=' + lang + '&format=json';
                $.get(url, function(data) {
                    if (data) {
                        var content = tmpl('banners_tmpl', data);

                        if (content) {
                            $('#banners').append(content);

                            $('img.lazy').lazyload();
                            $('img.lazy').removeClass('lazy');

                            autoScroll();
                        }
                    }
                });
            }

            $(document).ready(function () {

                initial();

                window.scrollTo(0, 1);

                registerEvents();

                pop_init();

                load_banners();

                /* Force initial hash change for loading */
                var event = document.createEvent("Events");
                event.initEvent("hashchange", true, false);
                window.dispatchEvent(event);

            });
        })(Zepto);

        (function updateAppCache() {
            function swapNewsCache() {
                try { //如果没有设置manifest文件， swapCache会报错
                    applicationCache.swapCache();
                    location.reload();
                } catch (err) {
                    console.warn(err);
                }
            }
            //缓存更新, 考虑到缓存更新成功可能发生在不同时间点，
            //在注册updateready时间之前，在之后手动检查更新之前，手动检查更新之后
            //并兼顾浏览器可能不自动检查更新的情况
            if (window.applicationCache) {
                applicationCache.addEventListener("updateready", function () {
                    if (applicationCache.status === applicationCache.UPDATEREADY) {
                        swapNewsCache();
                    }

                });
                if (applicationCache.status === applicationCache.UPDATEREADY) {
                    swapNewsCache();
                    return;
                }
                if (applicationCache.status === applicationCache.UNCACHED || applicationCache.status === applicationCache.IDLE || applicationCache.status === applicationCache.OBSOLETE) {
                    try { //如果没有设置manifest文件， update会报错
                        applicationCache.update();
                    } catch (err) {
                        console.warn(err);
                    }

                }
            }
        })();
    </script>
{% endcompress %}
{% endblock %}
