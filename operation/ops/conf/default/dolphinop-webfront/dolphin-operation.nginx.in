uwsgi_cache_path  /var/lib/nginx/opweb_cache  levels=1:2   keys_zone=opweb_cache:100m  max_size=500m;

server {
    listen           %(web_port)s;
    listen           443 ssl;
    ssl_certificate  /var/app/data/dolphinop-webfront/server.crt;
    ssl_certificate_key /var/app/data/dolphinop-webfront/server.key;
    server_name      %(web_url)s update.starfieldgame.com;
	gzip             on;
	gzip_comp_level  6;
	gzip_min_length  1000;
        gzip_proxied any;
        gzip_buffers 16 8k;
	gzip_types       application/javascript text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;
	gzip_disable     "msie6";

    root             /var/app/enabled/dolphinop-webfront/static/;

    log_format timed_combined '$remote_addr - $remote_user [$time_local]  '
                '"$request" $status $body_bytes_sent '
                '$request_time $upstream_response_time '
                '$upstream_cache_status '
                '"$http_referer" "$http_user_agent"';

    access_log       %(log_dir_base)s/dolphinop-webfront/access.log timed_combined;

	error_log       %(log_dir_base)s/dolphinop-webfront/error.log;
	index		 index.html index.htm index.php;

    proxy_connect_timeout 30;
    proxy_read_timeout 120;
    proxy_send_timeout 120;

    proxy_redirect off;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

	set $foreign_addr $remote_addr;
	if ($http_x_real_ip) {
		set $foreign_addr $http_x_real_ip;
	}
	
	proxy_set_header X-Real-IP $foreign_addr;
	
      location ~(favicon.ico) {
          alias /var/app/enabled/dolphinop-webfront/static/favicon.ico;
          log_not_found off;
          access_log off;
          expires 30d;
          break;
      }  
	

    location /static {
        alias /var/app/enabled/static-web/static;
    }
   # location ~* /static/[a-z_/]*\.(gif|jpg|jpeg|png|ico)$ {
   #     alias /var/app/enabled/static-web/static;
   #     expires 30d;
   # }
    
    location /api/1/sections {
        uwsgi_pass dolphinop;
        include uwsgi_params;
        uwsgi_cache opweb_cache;
        uwsgi_cache_key $uri?pn=$arg_pn&src=$arg_src&mt=$arg_mt;
        uwsgi_cache_valid 200 304 5m;
        uwsgi_cache_valid any 1m;
    }
    
    location /api/2/section {
        uwsgi_pass dolphinop;
        include uwsgi_params;
        uwsgi_cache opweb_cache;
        uwsgi_cache_key $uri?pn=$arg_pn&src=$arg_src&mt=$arg_mt;
        uwsgi_cache_valid 200 304 5m;
        uwsgi_cache_valid any 1m;
    }
    
    location /api/1/builtins {
        uwsgi_pass dolphinop;
        include uwsgi_params;
        uwsgi_cache opweb_cache;
        uwsgi_cache_key $uri?pname=$arg_pname&pn=$arg_pn&src=$arg_src&op=$arg_op;
        uwsgi_cache_valid 200 304 5m;
        uwsgi_cache_valid any 1m;
    }

    location /api/securityapps {
        uwsgi_pass dolphinop;
        include uwsgi_params;
        uwsgi_cache opweb_cache;
        uwsgi_cache_key $uri;
        uwsgi_cache_valid 200 304 5m;
        uwsgi_cache_valid any 1m;
    }
    
    location /api/1/recommend {
        uwsgi_pass dolphinop;
        include uwsgi_params;
        uwsgi_cache opweb_cache;
        uwsgi_cache_key $uri;
        uwsgi_cache_valid 200 304 5m;
        uwsgi_cache_valid any 1m;
    }
    
    location /api/1/treasure {
        uwsgi_pass dolphinop;
        include uwsgi_params;
        uwsgi_cache opweb_cache;
        uwsgi_cache_key $uri?pn=$arg_pn&src=$arg_src&vn=$arg_vn&mt=$arg_mt&op=$arg_op&fa=$arg_fa;
        uwsgi_cache_valid 200 304 5m;
        uwsgi_cache_valid any 1m;
    }
    
    location /api/1/updateservice {
        uwsgi_pass dolphinop;
        include uwsgi_params;
        uwsgi_cache opweb_cache;
        uwsgi_cache_key $uri?pn=$arg_pn&src=$arg_src&vn=$arg_vn&auto=$arg_auto;
        uwsgi_cache_valid 200 304 5m;
        uwsgi_cache_valid any 1m;
    }
    
    location /api/promolink {
        uwsgi_pass dolphinop;
        include uwsgi_params;
        uwsgi_cache opweb_cache;
        uwsgi_cache_key $uri?pn=$arg_pn&src=$arg_src&vn=$arg_vn&ver=$arg_ver&mt=$arg_mt&op=$arg_op&t=$arg_t;
        uwsgi_cache_valid 200 304 5m;
        uwsgi_cache_valid any 1m;
    }

    location /api/1/adverts {
        uwsgi_pass dolphinop-external;
        include uwsgi_params;
        uwsgi_cache opweb_cache;
        uwsgi_cache_key $request_uri;
        uwsgi_cache_valid 200 304 5m;
        uwsgi_cache_valid any 1m;
    }

    location /api/1/advert.json {
        uwsgi_pass dolphinop;
        include uwsgi_params;
    }

    location /service/1/weathers {
        uwsgi_pass dolphinop-external;
        include uwsgi_params;
    }

    location /api {
        uwsgi_pass dolphinop;
        include uwsgi_params;
        uwsgi_cache opweb_cache;
        uwsgi_cache_key $request_uri;
        uwsgi_cache_valid 200 304 5m;
        uwsgi_cache_valid any 1m;
    }
    location /pages { uwsgi_pass dolphinop; include uwsgi_params; uwsgi_cache opweb_cache;
        uwsgi_cache_key $request_uri;
        uwsgi_cache_valid 200 304 5m;
    }

    location / {
        uwsgi_pass dolphinop;
        include uwsgi_params;
    }

    location /resources {
        alias /home/static/resources;
        expires 30d;
        error_log /dev/null crit;
    }
    
    location /nginx-status {
        stub_status on;
        allow 127.0.0.1;
        allow 119.97.214.98;
        deny all;
    }
}

upstream dolphinop{
###template(dolphinop_service)
        server %(#dolphinop_service.ip)s:%(#dolphinop_service.http_port)s;
###
}

upstream dolphinop-external{
###template(dolphinop_service)
        server %(#dolphinop_service.ip)s:%(#dolphinop_service.http_port)s;
###
}
